name: Deploy to Alibaba Cloud OSS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository with the last two commits
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Fetch the last two commits

      # Step 2: Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # Step 3: Install workflow dependencies (OSS SDK)
      - name: Install workflow dependencies (OSS SDK)
        run: npm install ali-oss --prefix ./workflow_modules

      # Step 4: Set NODE_PATH
      - name: Set NODE_PATH
        run: export NODE_PATH=$NODE_PATH:./workflow_modules/node_modules

      # Step 5: Run OSS Upload Script
      - name: Run OSS Upload Script
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
          OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
        run: node uploadToOSS.js
